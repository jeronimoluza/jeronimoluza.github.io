+++
title = 'Bypassing AWS Athena "Query Exhausted Resources" using H3 Hexagons'
date = 2024-10-17T16:25:52-04:00
+++

If you work with Amazon Web Services (AWS) Athena SQL, chances are that you've encountered the following error:

`Query exhausted resources at this scale factor`

This generally indicates that you are hitting memory limits on the Athena cluster that runs your query ([reference 1](https://repost.aws/questions/QU5M0ASE-_R_mvSMXDWrnuDA/athena-version-3-error-query-exhausted-resources-at-this-scale-factor), [reference 2](https://repost.aws/questions/QUdYYEXbb0QMuKX6TwDl17GA/athena-query-exhausted-resources-at-this-scale-factor), [reference 3](https://repost.aws/knowledge-center/athena-query-exhausted)). AWS provides several [performance optimization strategies](https://docs.aws.amazon.com/athena/latest/ug/performance-tuning.html), including [data optimization](https://docs.aws.amazon.com/athena/latest/ug/performance-tuning-data-optimization-techniques.html), [query optimization](https://docs.aws.amazon.com/athena/latest/ug/performance-tuning-query-optimization-techniques.html), and [data partitioning](https://docs.aws.amazon.com/athena/latest/ug/partition-projection.html#partition-projection-using).

One way to bypass Athena’s resource limitations for large geospatial queries is to segment intersection operations into a structured sequence of steps. For example, instead of attempting to intersect a large number of small polygons with line geometries all at once—which can cause queries to fail—one can first intersect the lines with larger enclosing geometries, such as administrative boundaries or grid cells. This initial step acts as a filter, identifying only the linestrings that intersect with these larger geometries. The next step is to take these filtered lines and intersect them with the smaller polygons contained within the intersected larger geometries. By introducing more intermediate steps, we further reduce the number of geometries processed at each stage, making it easier for Athena to handle the query efficiently and preventing resource exhaustion.

H3 hexagons provide a natural framework for building this hierarchical structure of intersections by organizing spatial relationships from broader to finer resolutions, moving from parent hexagons to their child hexagons. Each H3 hexagon can be subdivided into smaller hexagons at the next resolution level, so intersections can first be evaluated at a coarser level, where each parent hexagon encompasses multiple child hexagons. This means initial intersections can identify general areas of interest at a lower resolution, while subsequent intersections at higher resolutions focus only on the children of those hexagons where intersections were previously found, reducing the number of comparisons needed at each step and enables scalable geometric operations by narrowing the scope of detailed calculations to smaller, relevant areas.

This strategy avoids the otherwise immense cartesian product that results from a direct intersection of a large number of geometries with a dense, high-resolution grid. By gradually filtering data at each level, the process sidesteps Athena's memory constraints and makes it possible to perform detailed geospatial operations in stages.

I'm currently working on a project to create a structured, hierarchical database connecting each coarse hexagon in the grid to its finer-resolution counterparts by calculating an optimal disk size for coverage between resolutions. This disk size represents the number of hexagons in the finer grid needed to fully enclose each coarser-resolution hexagon, ensuring that each area in the coarse grid is spatially represented by an equivalent group of smaller hexagons in the next resolution level. The disk size is determined based on the difference between the current and target resolutions, meaning that for each transition to a higher resolution, the algorithm calculates how many neighboring hexagons (in a disk shape) are needed to encapsulate the space covered by the original coarser hexagon.

![](./images/parent_centerchild.png)

![](./images/centerchilds_griddisks.png)

As the process moves from one resolution level to the next, it generates a series of databases or tables that capture these hierarchical relationships. Starting with an initial set of parent hexagons at a low resolution, each database created at subsequent levels tracks which finer-resolution hexagons correspond to each hexagon at the previous level. The code ensures this by calculating and storing the exact set of finer hexagons (or "disk") associated with each coarse hexagon. This approach results in a cascading structure of tables, where each level contains a set of spatial mappings that allow intersection operations to proceed in stages, focusing only on increasingly smaller sets of hexagons. This prevents the need for an exhaustive, computationally prohibitive comparison across all hexagons at the highest resolution, enabling efficient and manageable geospatial operations across multiple levels of detail.
